#!/usr/bin/env bash
set -euo pipefail

# Pre-commit hook for NixOS configuration validation
# This hook runs comprehensive validation checks and secret scanning before allowing commits

## Colors
GREEN="\033[0;32m"
YELLOW="\033[1;33m"
RED="\033[0;31m"
BLUE="\033[0;34m"
NC="\033[0m"

main() {
    set_repo_root
    print_header
    check_secrets_comprehensive
    check_nix_syntax
    check_formatting
    check_security
    check_nixos_config
    check_build_test
    check_large_files
    print_summary
}

set_repo_root() {
    REPO_ROOT="$(git rev-parse --show-toplevel)"
    cd "$REPO_ROOT" || exit
}

print_header() {
    echo -e "${BLUE}ðŸ” Running NixOS configuration validation...${NC}"
    FAILED=0
}

check_secrets_comprehensive() {
    echo -e "\n${BLUE}1. Comprehensive secret scanning...${NC}"

    # Run git-secrets first (fast)
    if command -v git >/dev/null 2>&1 && git secrets --list >/dev/null 2>&1; then
        if git secrets --pre_commit_hook -- "$@"; then
            log_success "git-secrets: no secrets detected"
        else
            log_error "git-secrets: secrets detected"
            return
        fi
    else
        log_info "git-secrets not configured, skipping"
    fi

    # Run comprehensive secret scan if available
    if [ -f "$REPO_ROOT/scripts/security/precommit-scan.sh" ]; then
        log_info "Running comprehensive secret scan..."
        if "$REPO_ROOT/scripts/security/precommit-scan.sh"; then
            log_success "Comprehensive secret scan: clean"
        else
            log_error "Comprehensive secret scan: issues found"
        fi
    else
        log_info "Comprehensive secret scanner not available"
    fi
}

check_nix_syntax() {
    echo -e "\n${BLUE}2. Checking Nix syntax...${NC}"
    # Check syntax of staged Nix files only (not full evaluation)
    staged_nix_files=$(git diff --cached --name-only | grep -E '\.nix$' || true)
    if [ -n "$staged_nix_files" ]; then
        SYNTAX_ERRORS=0
        for file in $staged_nix_files; do
            if [ -f "$file" ]; then
                if nix-instantiate --parse "$file" >/dev/null 2>&1; then
                    : # Parse OK
                else
                    log_error "Syntax error in $file"
                    SYNTAX_ERRORS=1
                fi
            fi
        done
        if [ $SYNTAX_ERRORS -eq 0 ]; then
            log_success "Nix syntax validation passed for staged files"
        fi
    else
        log_info "No staged Nix files to check"
    fi

    # Optional: Full flake check if environment variable is set
    if [ "${NIXOS_VALIDATE_FLAKE:-false}" = "true" ]; then
        log_info "Running full flake check..."
        if nix flake check --no-build 2>/dev/null; then
            log_success "Full flake evaluation passed"
        else
            log_warning "Full flake check failed (non-blocking, use NIXOS_VALIDATE_FLAKE=false to skip)"
        fi
    fi
}

check_formatting() {
    echo -e "\n${BLUE}3. Checking code formatting...${NC}"
    staged_nix_files=$(git diff --cached --name-only | grep -E '\.nix$' || true)
    if [ -n "${staged_nix_files}" ]; then
        if echo "$staged_nix_files" | xargs grep -l $'\t' 2>/dev/null; then
            log_warning "Found tabs in Nix files (consider using spaces)"
        else
            log_success "No tabs found in staged Nix files"
        fi
    else
        log_info "No staged Nix files to check for tabs"
    fi
    if git diff --cached --check 2>/dev/null; then
        log_success "No trailing whitespace found"
    else
        log_warning "Trailing whitespace found (will be highlighted above)"
    fi
}

check_security() {
    echo -e "\n${BLUE}4. Running security configuration checks...${NC}"
    SECURITY_ISSUES=0

    # Check for security module (optional, not critical)
    if grep -r "security\s*=" systems/ 2>/dev/null >/dev/null || \
       grep -r "security\..*=" modules/ 2>/dev/null >/dev/null; then
        log_success "Security configuration present"
    else
        log_info "No explicit security module configuration found"
    fi

    # Check for dangerous SSH settings in staged files
    staged_files=$(git diff --cached --name-only || true)
    if [ -n "$staged_files" ]; then
        if echo "$staged_files" | xargs grep -l "PasswordAuthentication.*=.*true" 2>/dev/null | grep -v "pre-commit" | head -1; then
            log_error "Found SSH password authentication enabled in staged files"
            SECURITY_ISSUES=1
        fi
        if echo "$staged_files" | xargs grep -l 'PermitRootLogin.*=.*"yes"' 2>/dev/null | grep -v "pre-commit" | head -1; then
            log_error "Found root SSH login enabled in staged files"
            SECURITY_ISSUES=1
        fi
    fi

    if [ $SECURITY_ISSUES -eq 0 ]; then
        log_success "No obvious security issues found in staged files"
    fi
}

check_nixos_config() {
    echo -e "\n${BLUE}5. Validating NixOS-specific configurations...${NC}"
    CONFIG_ISSUES=0

    # Check for basic structure
    if [ ! -d "modules/system" ] && [ ! -d "modules/home" ]; then
        log_error "Missing module directories (modules/system or modules/home)"
        CONFIG_ISSUES=1
    fi
    if [ ! -f "flake.nix" ]; then
        log_error "Missing flake.nix file"
        CONFIG_ISSUES=1
    fi

    # Check for broken imports in staged files
    staged_nix_files=$(git diff --cached --name-only | grep -E '\.nix$' || true)
    if [ -n "$staged_nix_files" ]; then
        broken_imports=0
        for nix_file in $staged_nix_files; do
            if [ -f "$nix_file" ] && grep -q "^\s*\./" "$nix_file" 2>/dev/null; then
                while IFS= read -r import_line; do
                    # Extract the first './path' occurrence
                    tmp="${import_line#*./}"
                    if [ "$tmp" != "$import_line" ]; then
                        # Strip everything after the first double-quote or space
                        import_path="./${tmp%%[\" ]*}"
                    else
                        import_path=""
                    fi
                    if [ -n "$import_path" ]; then
                        full_path="$(dirname "$nix_file")/$import_path"
                        if [ ! -f "$full_path" ] && [ ! -d "$full_path" ] && [ ! -f "$full_path.nix" ]; then
                            log_error "Broken import in $nix_file: $import_path"
                            broken_imports=1
                            CONFIG_ISSUES=1
                        fi
                    fi
                done < <(grep "^\s*\./" "$nix_file" 2>/dev/null || true)
            fi
        done
    fi

    if [ $CONFIG_ISSUES -eq 0 ]; then
        log_success "NixOS configuration structure looks good"
    fi
}

check_build_test() {
    if [ "${NIXOS_VALIDATE_BUILD:-false}" = "true" ]; then
        echo -e "\n${BLUE}6. Testing build (this may take a while)...${NC}"
        # Get the first nixosConfiguration name
        system_name=$(nix flake show --json 2>/dev/null | grep -o '"nixosConfigurations":{[^}]*"[^"]*"' | grep -o '"[^"]*"$' | tr -d '"' | head -1 || echo "")
        if [ -n "$system_name" ]; then
            if nix build ".#nixosConfigurations.$system_name.config.system.build.toplevel" --no-link 2>/dev/null; then
                log_success "Configuration builds successfully"
            else
                log_error "Configuration fails to build"
            fi
        else
            log_warning "Could not determine system name for build test"
        fi
    else
        echo -e "\n${BLUE}6. Skipping build test${NC} (set NIXOS_VALIDATE_BUILD=true to enable)"
    fi
}

check_large_files() {
    echo -e "\n${BLUE}7. Checking for large files...${NC}"
    LARGE_FILES=0
    while IFS= read -r file; do
        if [ -n "$file" ]; then
            size=$(git cat-file -s ":$file" 2>/dev/null || echo 0)
            if [ "$size" -gt 1048576 ]; then
                log_warning "Large file found: $file ($(( size / 1024 ))KB)"
                LARGE_FILES=1
            fi
        fi
    done < <(git diff --cached --name-only)
    if [ $LARGE_FILES -eq 0 ]; then
        log_success "No large files found"
    fi
}

print_summary() {
    echo -e "\n${BLUE}ðŸ“‹ Validation Summary${NC}"
    if [ $FAILED -eq 0 ]; then
        echo -e "${GREEN}ðŸŽ‰ All critical checks passed! Commit proceeding...${NC}"
        exit 0
    else
        echo -e "${RED}ðŸ’¥ Some critical checks failed. Commit blocked.${NC}"
        echo -e "${YELLOW}ðŸ’¡ Fix the issues above or use 'git commit --no-verify' to bypass${NC}"
        exit 1
    fi
}

# Logging functions
log_success() {
    echo -e "${GREEN}âœ“${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}âš ${NC} $1"
}

log_info() {
    echo -e "${BLUE}â„¹${NC} $1"
}

log_error() {
    echo -e "${RED}âœ—${NC} $1"
    FAILED=1
}

main "$@"
